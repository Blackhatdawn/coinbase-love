# Render.com Deployment Configuration
# CryptoVault Backend - Production Ready
# Last Updated: 2026-02-09

services:
  # Backend API Service
  - type: web
    name: cryptovault-backend
    runtime: python
    plan: starter  # Upgrade to standard/pro for more resources
    region: oregon  # Choose closest to your users: oregon, frankfurt, singapore
    rootDir: backend
    buildCommand: |
      pip install --upgrade pip && 
      pip install -r backend/requirements.txt &&
      python -c "import config; print('Config loaded successfully')"
    startCommand: |
      cd backend &&
      echo "Starting CryptoVault Backend..." &&
      echo "Environment: $ENVIRONMENT" &&
      echo "Port: $PORT" &&
      uvicorn server:app --host 0.0.0.0 --port $PORT --workers 4 --http h11 --proxy-headers --forwarded-allow-ips '*'
    
    envVars:
      # ============================================
      # APPLICATION SETTINGS
      # ============================================
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: "false"
      - key: LOG_LEVEL
        value: INFO
      - key: APP_NAME
        value: CryptoVault
      - key: APP_VERSION
        value: "2.0.0"
      - key: WORKERS
        value: "4"
      
      # ============================================
      # DATABASE (MongoDB Atlas)
      # ============================================
      - key: MONGO_URL
        sync: false  # Set as secret in Render dashboard
      - key: DB_NAME
        value: cryptovault
      - key: MONGO_MAX_POOL_SIZE
        value: "10"
      - key: MONGO_TIMEOUT_MS
        value: "5000"
      
      # ============================================
      # AUTHENTICATION (JWT)
      # ============================================
      - key: JWT_SECRET
        sync: false  # Set as secret
      - key: JWT_ALGORITHM
        value: HS256
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "30"
      - key: REFRESH_TOKEN_EXPIRE_DAYS
        value: "7"
      - key: CSRF_SECRET
        sync: false  # Set as secret
      
      # ============================================
      # CORS & COOKIES
      # ============================================
      - key: CORS_ORIGINS
        value: '["https://www.cryptovault.financial","https://cryptovault.financial","https://coinbase-love.vercel.app"]'
      - key: USE_CROSS_SITE_COOKIES
        value: "true"
      - key: COOKIE_SAMESITE
        value: lax
      - key: COOKIE_SECURE
        value: "true"
      
      # ============================================
      # PUBLIC URLs
      # ============================================
      - key: APP_URL
        value: https://www.cryptovault.financial
      - key: PUBLIC_API_URL
        value: https://cryptovault-api.onrender.com
      - key: PUBLIC_WS_URL
        value: wss://cryptovault-api.onrender.com
      - key: PUBLIC_SOCKET_IO_PATH
        value: /socket.io/
      - key: EMAIL_VERIFICATION_URL
        value: https://cryptovault.financial/verify
      
      # ============================================
      # RATE LIMITING
      # ============================================
      - key: RATE_LIMIT_PER_MINUTE
        value: "60"
      - key: COINCAP_RATE_LIMIT
        value: "200"
      
      # ============================================
      # EMAIL (SendGrid)
      # ============================================
      - key: EMAIL_SERVICE
        value: mock  # Change to 'sendgrid' when valid key available
      - key: EMAIL_FROM
        value: team@cryptovault.financial
      - key: EMAIL_FROM_NAME
        value: "CryptoVault Financial"
      - key: SENDGRID_API_KEY
        sync: false  # Set as secret - NEED NEW VALID KEY
      
      # ============================================
      # TELEGRAM NOTIFICATIONS
      # ============================================
      - key: TELEGRAM_ENABLED
        value: "true"
      - key: TELEGRAM_BOT_TOKEN
        sync: false  # Set as secret
      - key: ADMIN_TELEGRAM_CHAT_ID
        sync: false  # Set as secret (comma-separated IDs)
      
      # ============================================
      # EXTERNAL APIs
      # ============================================
      - key: COINCAP_API_KEY
        sync: false  # Set as secret
      
      # ============================================
      # PAYMENTS (NOWPayments)
      # ============================================
      - key: NOWPAYMENTS_API_KEY
        sync: false  # Set as secret
      - key: NOWPAYMENTS_IPN_SECRET
        sync: false  # Set as secret
      - key: NOWPAYMENTS_SANDBOX
        value: "false"
      
      # ============================================
      # CACHE (Upstash Redis)
      # ============================================
      - key: USE_REDIS
        value: "true"
      - key: UPSTASH_REDIS_REST_URL
        sync: false  # Set as secret
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false  # Set as secret
      - key: REDIS_PREFIX
        value: "cryptovault:prod:"
      
      # ============================================
      # MONITORING (Sentry)
      # ============================================
      - key: SENTRY_DSN
        sync: false  # Set as secret
      - key: SENTRY_TRACES_SAMPLE_RATE
        value: "0.1"
      - key: SENTRY_PROFILES_SAMPLE_RATE
        value: "0.1"
      
      # ============================================
      # FEATURE FLAGS
      # ============================================
      - key: USE_MOCK_PRICES
        value: "false"
      - key: FEATURE_2FA_ENABLED
        value: "true"
      - key: FEATURE_DEPOSITS_ENABLED
        value: "true"
      - key: FEATURE_STAKING_ENABLED
        value: "false"
      - key: FEATURE_TRADING_ENABLED
        value: "true"
      - key: FEATURE_WITHDRAWALS_ENABLED
        value: "true"
      
      # ============================================
      # PUBLIC CONFIG (exposed to frontend)
      # ============================================
      - key: PUBLIC_LOGO_URL
        value: https://www.cryptovault.financial/logo.svg
      - key: PUBLIC_SITE_NAME
        value: "CryptoVault Financial"
      - key: PUBLIC_SUPPORT_EMAIL
        value: support@cryptovault.financial
    
    # Health check endpoint
    healthCheckPath: /api/health
    
    # Auto-deploy on push to main branch
    autoDeploy: true
    
    # Disk storage (optional, for logs/temp files)
    disk:
      name: cryptovault-disk
      mountPath: /app/data
      sizeGB: 1

# ============================================
# FRONTEND (Optional - Uncomment if deploying to Render)
# ============================================
#  - type: web
#    name: cryptovault-frontend
#    runtime: static
#    buildCommand: cd frontend && yarn install && yarn build
#    staticPublishPath: frontend/dist
#    envVars:
#      - key: VITE_API_BASE_URL
#        value: https://cryptovault-api.onrender.com
#    routes:
#      - type: rewrite
#        source: /*
#        destination: /index.html
