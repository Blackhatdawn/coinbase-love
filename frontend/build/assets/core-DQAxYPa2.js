import{r as e,j as t}from"./vendor-BDLfEzqu.js";import{u as a}from"./ui-vendor-DZd8bb7k.js";import{f as o,B as r,p as s,a as n}from"./web3-vendor-CvFXyCg7.js";let i=0;const c=new Map,l=e=>{if(c.has(e))return;const t=setTimeout(()=>{c.delete(e),w({type:"REMOVE_TOAST",toastId:e})},5e3);c.set(e,t)},d=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{const{toastId:a}=t;return{...e,toasts:e.toasts.map(e=>e.id===a||void 0===a?{...e,open:!1}:e)}}case"REMOVE_TOAST":return void 0===t.toastId?{...e,toasts:[]}:{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},u=[];let h,m={toasts:[]};function w(e){m=d(m,e),u.forEach(e=>{e(m)})}function g(e){w({type:"DISMISS_TOAST",toastId:e}),e?l(e):m.toasts.forEach(e=>{l(e.id)})}function f({...e}){const t=(i=(i+1)%Number.MAX_SAFE_INTEGER,i.toString()),a=()=>g(t);return w({type:"ADD_TOAST",toast:{...e,id:t,open:!0,onOpenChange:e=>{e||a()}}}),{id:t,dismiss:a,update:e=>w({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function p(){const[t,a]=e.useState(m);return e.useEffect(()=>(u.push(a),()=>{const e=u.indexOf(a);e>-1&&u.splice(e,1)}),[]),{...t,toast:f,dismiss:e=>g(e)}}console.error("âŒ CRITICAL: VITE_API_URL is not set in production!"),console.error("ðŸ”§ Set VITE_API_URL in Vercel environment variables."),h="/api",console.log(`ðŸ”Œ API Base: ${h}`),console.error("âš ï¸  VITE_API_URL not configured - API calls will fail!");const y={maxRetries:3,delays:[2e3,5e3,1e4]};class S extends Error{constructor(e,t){super(t),this.status=e,this.name="APIError"}}let T=!1,E=null;const A=async(e,t={},a=0)=>{const o=`${h}${e}`,r={"Content-Type":"application/json",...t.headers};try{let a=await fetch(o,{...t,headers:r,credentials:"include"});if(401===a.status&&"/auth/refresh"!==e&&"/auth/login"!==e&&"/auth/signup"!==e&&(T&&E?(await E,a=await fetch(o,{...t,headers:r,credentials:"include"})):T||(T=!0,E=(async()=>{try{await fetch(`${h}/auth/refresh`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})}catch(e){console.error("Token refresh failed:",e)}finally{T=!1,E=null}})(),await E,a=await fetch(o,{...t,headers:r,credentials:"include"}))),!a.ok){const e=await a.json().catch(()=>({error:"Unknown error"}));throw new S(a.status,e.error||e.detail||"Request failed")}return await a.json()}catch(s){if(s instanceof S)throw s;const o=s instanceof TypeError,r=s instanceof Error?s.message:"Unknown error";if(a<y.maxRetries&&o){const o=y.delays[a];if(console.log(`ðŸ”„ Retrying request (attempt ${a+1}/${y.maxRetries}) after ${o}ms...`),0===a){const e="â³ Backend is waking up from idle state... This may take 30-60 seconds on first request. Please wait...";console.log(e),"undefined"!=typeof window&&window.__showToast&&window.__showToast(e,"loading")}return await new Promise(e=>setTimeout(e,o)),A(e,t,a+1)}if(r.includes("Failed to fetch")||r.includes("CORS"))throw new S(0,`Backend connection failed. Check: 1) Backend is running, 2) CORS is configured, 3) Network is stable. Original error: ${r}`);throw new S(0,r)}},O={auth:{signup:(e,t,a)=>A("/auth/signup",{method:"POST",body:JSON.stringify({email:e,password:t,name:a})}),login:(e,t)=>A("/auth/login",{method:"POST",body:JSON.stringify({email:e,password:t})}),logout:()=>A("/auth/logout",{method:"POST"}),getProfile:()=>A("/auth/me"),refresh:()=>A("/auth/refresh",{method:"POST"}),verifyEmail:(e,t)=>A("/auth/verify-email",{method:"POST",body:JSON.stringify({token:e,email:t})}),setup2FA:()=>A("/auth/2fa/setup",{method:"POST"}),verify2FA:e=>A("/auth/2fa/verify",{method:"POST",body:JSON.stringify({code:e})}),get2FAStatus:()=>A("/auth/2fa/status"),disable2FA:e=>A("/auth/2fa/disable",{method:"POST",body:JSON.stringify({password:e})}),getBackupCodes:()=>A("/auth/2fa/backup-codes",{method:"POST"})},crypto:{getAll:()=>A("/crypto"),getOne:e=>A(`/crypto/${e}`),getHistory:(e,t=7)=>A(`/crypto/${e}/history?days=${t}`)},portfolio:{get:()=>A("/portfolio"),getHolding:e=>A(`/portfolio/holding/${e}`),addHolding:(e,t,a)=>A("/portfolio/holding",{method:"POST",body:JSON.stringify({symbol:e,name:t,amount:a})}),deleteHolding:e=>A(`/portfolio/holding/${e}`,{method:"DELETE"})},orders:{getAll:()=>A("/orders"),create:(e,t,a,o,r)=>A("/orders",{method:"POST",body:JSON.stringify({trading_pair:e,order_type:t,side:a,amount:o,price:r})}),getOne:e=>A(`/orders/${e}`),cancel:e=>A(`/orders/${e}/cancel`,{method:"POST"})},transactions:{getAll:(e=50,t=0)=>A(`/transactions?limit=${e}&offset=${t}`),getOne:e=>A(`/transactions/${e}`),create:(e,t,a,o)=>A("/transactions",{method:"POST",body:JSON.stringify({type:e,amount:t,symbol:a,description:o})}),getStats:()=>A("/transactions/stats/overview")},auditLogs:{getLogs:(e=50,t=0,a)=>{let o=`/audit-logs?limit=${e}&offset=${t}`;return a&&(o+=`&action=${a}`),A(o)},getSummary:(e=30)=>A(`/audit-logs/summary?days=${e}`),exportLogs:(e=90)=>A(`/audit-logs/export?days=${e}`),getLog:e=>A(`/audit-logs/${e}`)}},I=e.createContext(void 0),P=({children:a})=>{const[o,r]=e.useState(null),[s,n]=e.useState(!0);e.useEffect(()=>{(async()=>{try{const e=await O.auth.getProfile(),t={id:e.user.id,email:e.user.email,name:e.user.name,createdAt:e.user.createdAt};r(t)}catch(e){e?.status&&401!==e.status&&0!==e.status&&console.warn("âš ï¸ Session check failed:",e.message),r(null)}finally{n(!1)}})()},[]);return t.jsx(I.Provider,{value:{user:o,isLoading:s,signIn:async(e,t)=>{try{const a=await O.auth.login(e,t),o={id:a.user.id,email:a.user.email,name:a.user.name,createdAt:a.user.createdAt};return r(o),{}}catch(a){return{error:a.message||"Failed to sign in"}}},signUp:async(e,t,a)=>{try{const o=await O.auth.signup(e,t,a),s={id:o.user.id,email:o.user.email,name:o.user.name,createdAt:o.user.createdAt};return r(s),{}}catch(o){return{error:o.message||"Failed to create account"}}},signOut:async()=>{try{await O.auth.logout()}catch(e){console.error("Logout error:",e)}r(null)}},children:a})},v=()=>{const t=e.useContext(I);if(void 0===t)throw new Error("useAuth must be used within an AuthProvider");return t},b={ETHEREUM_MAINNET:{chainId:"0x1",chainName:"Ethereum Mainnet",nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:["https://mainnet.infura.io/v3/"],blockExplorerUrls:["https://etherscan.io"]},POLYGON_MAINNET:{chainId:"0x89",chainName:"Polygon Mainnet",nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},rpcUrls:["https://polygon-rpc.com"],blockExplorerUrls:["https://polygonscan.com"]},ETHEREUM_SEPOLIA:{chainId:"0xaa36a7",chainName:"Ethereum Sepolia",nativeCurrency:{name:"SepoliaETH",symbol:"ETH",decimals:18},rpcUrls:["https://sepolia.infura.io/v3/"],blockExplorerUrls:["https://sepolia.etherscan.io"]}},k=e.createContext(void 0),C=({children:i})=>{const[c,l]=e.useState(!1),[d,u]=e.useState(null),[h,m]=e.useState(null),[w,g]=e.useState(null),[f,p]=e.useState(null),[y,S]=e.useState(null),[T,E]=e.useState(null),[A,O]=e.useState(!1),[I,P]=e.useState(!1),v=e=>({"0x1":"Ethereum","0x89":"Polygon","0xaa36a7":"Sepolia"}[e]||"Unknown Network"),C=e.useCallback(async(e,t)=>{try{const a=await t.getBalance(e);m(o(a))}catch(a){console.error("Error fetching balance:",a)}},[]),$=async()=>{if(void 0!==window.ethereum)try{O(!0);const e=await window.ethereum.request({method:"eth_requestAccounts"});if(0===e.length)throw new Error("No accounts found");const t=new r(window.ethereum),o=await t.getSigner(),s=await t.getNetwork();S(t),E(o),u(e[0]),g(`0x${s.chainId.toString(16)}`),p(v(`0x${s.chainId.toString(16)}`)),l(!0),await C(e[0],t),a.success("Wallet connected!",{description:`Connected to ${e[0].slice(0,6)}...${e[0].slice(-4)}`}),localStorage.setItem("walletConnected","true"),localStorage.setItem("walletAddress",e[0])}catch(e){console.error("Error connecting wallet:",e),a.error("Failed to connect wallet",{description:e.message||"Please try again."})}finally{O(!1)}else a.error("MetaMask not detected",{description:"Please install MetaMask to use wallet features."})},N=()=>{l(!1),u(null),m(null),g(null),p(null),S(null),E(null),localStorage.removeItem("walletConnected"),localStorage.removeItem("walletAddress"),a.info("Wallet disconnected")};e.useEffect(()=>{"true"===localStorage.getItem("walletConnected")&&window.ethereum&&$()},[]),e.useEffect(()=>{if(!window.ethereum)return;const e=e=>{0===e.length?N():e[0]!==d&&(u(e[0]),y&&C(e[0],y),a.info("Account changed",{description:`${e[0].slice(0,6)}...${e[0].slice(-4)}`}))},t=e=>{g(e),p(v(e)),a.info("Network changed",{description:v(e)}),window.location.reload()};return window.ethereum.on("accountsChanged",e),window.ethereum.on("chainChanged",t),()=>{window.ethereum?.removeListener("accountsChanged",e),window.ethereum?.removeListener("chainChanged",t)}},[d,y,C]);const _={isConnected:c,account:d,balance:h,chainId:w,networkName:f,provider:y,signer:T,connectWallet:$,disconnectWallet:N,switchNetwork:async e=>{if(window.ethereum)try{P(!0),await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:e}]}),a.success("Network switched successfully")}catch(t){if(4902===t.code)try{const t=Object.values(b).find(t=>t.chainId===e);t&&(await window.ethereum.request({method:"wallet_addEthereumChain",params:[t]}),a.success("Network added and switched"))}catch(o){a.error("Failed to add network",{description:o.message})}else a.error("Failed to switch network",{description:t.message})}finally{P(!1)}else a.error("MetaMask not detected")},sendTransaction:async(e,t)=>{if(!T)throw new Error("Wallet not connected");try{const o=await T.sendTransaction({to:e,value:s(t)});a.info("Transaction submitted",{description:`Hash: ${o.hash.slice(0,10)}...`});const r=await o.wait();return 1===r?.status&&(a.success("Transaction confirmed!"),d&&y&&await C(d,y)),o.hash}catch(o){throw a.error("Transaction failed",{description:o.message}),o}},getGasPrice:async()=>{if(!y)throw new Error("Provider not available");try{const e=await y.getFeeData();return e.gasPrice?n(e.gasPrice,"gwei"):"0"}catch(e){return console.error("Error fetching gas price:",e),"0"}},estimateGas:async(e,t)=>{if(!y||!d)throw new Error("Wallet not connected");try{return(await y.estimateGas({from:d,to:e,value:s(t)})).toString()}catch(a){return console.error("Error estimating gas:",a),"21000"}},isConnecting:A,isSwitchingNetwork:I};return t.jsx(k.Provider,{value:_,children:i})},$=()=>{const t=e.useContext(k);if(void 0===t)throw new Error("useWeb3 must be used within a Web3Provider");return t};let N=[];const _=t=>{const a=e.useRef(t);e.useEffect(()=>{a.current=t},[t]),e.useEffect(()=>{const e=e=>{a.current?.(e)};return N.push(e),()=>{N=N.filter(t=>t!==e)}},[])};export{P as A,b as S,C as W,p as a,O as b,$ as c,_ as d,v as u};
